<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dashboard</title>
    <script src="https://unpkg.com/mathlive"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js"></script>

    <style>
        body { font-family: sans-serif; background: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); margin: 0; padding: 16px; min-height: 100vh; display: flex; flex-direction: column; }
        math-field { width: 100%; font-size: 24px; padding: 8px; background: white !important; color: black !important; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; }
        textarea { width: 100%; height: 100px; border-radius: 12px; padding: 12px; border: 1px solid #ccc; background: var(--tg-theme-secondary-bg-color, #f5f5f5); color: var(--tg-theme-text-color, #000); resize: none; outline: none; box-sizing: border-box;}
        button { border: none; padding: 14px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-insert { background: #e0e0e0; color: #333; }
        .btn-send { background: var(--tg-theme-button-color, #3390ec); color: white; }
        .answer-box { background: var(--tg-theme-section-bg-color, #fff); padding: 16px; border-radius: 12px; border: 1px solid #eee; word-wrap: break-word; }
        
        /* –ê–î–ú–ò–ù–ö–ê */
        #admin-mode { display: none; flex-direction: column; height: 100vh; }
        .user-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #ccc; }
        .user-card { min-width: 120px; background: var(--tg-theme-secondary-bg-color, #eee); padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; border: 2px solid transparent; }
        .user-card.active { border-color: var(--tg-theme-button-color, #3390ec); background: #fff; }
        .user-name { font-weight: bold; font-size: 14px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 110px; }
        .user-id { font-size: 11px; opacity: 0.6; }
        .chat-viewer { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 8px; }
        .msg { padding: 10px; border-radius: 8px; max-width: 85%; font-size: 14px; }
        .msg.user { align-self: flex-end; background: var(--tg-theme-button-color, #3390ec); color: white; }
        .msg.assistant { align-self: flex-start; background: var(--tg-theme-secondary-bg-color, #e0e0e0); color: var(--tg-theme-text-color, #000); }
        .hidden { display: none !important; }
        .query-quote { border-left: 3px solid #ccc; padding-left: 10px; margin-bottom: 10px; opacity: 0.7; font-size: 0.9em; }
        /* üÜï –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —á–∞—Ç–æ–≤ */
        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏: –Ω–µ —Å–ø–ª—é—â–∏–≤–∞—é—Ç—Å—è, —É–¥–æ–±–Ω—ã –¥–ª—è –ø–∞–ª—å—Ü–∞ */
        button { 
            border: none; 
            padding: 14px 20px; /* –ë–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø—ã */
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 10px;
            min-height: 50px; /* üÜï –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
            display: flex; align-items: center; justify-content: center; /* –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ */
            flex-shrink: 0; /* üÜï –ó–∞–ø—Ä–µ—Ç –Ω–∞ —Å–∂–∞—Ç–∏–µ */
        }
        
        .btn-insert { background: #e0e0e0; color: #333; }
        .btn-send { background: var(--tg-theme-button-color, #3390ec); color: white; }
        
        /* –ß–∏–ø—ã (–∫–Ω–æ–ø–∫–∏ —á–∞—Ç–æ–≤) */
        .session-bar {
            display: flex; gap: 8px; overflow-x: auto; padding: 10px 5px; 
            background: transparent;
            white-space: nowrap; 
            -webkit-overflow-scrolling: touch; /* –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞ iOS */
            scrollbar-width: none; /* –°–∫—Ä—ã—Ç—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        }
        .chip {
            padding: 10px 16px; 
            border-radius: 20px; 
            font-size: 14px; 
            font-weight: 500;
            cursor: pointer;
            background: var(--tg-theme-secondary-bg-color, #fff); 
            border: 1px solid #ccc; 
            color: var(--tg-theme-text-color, #000); 
            transition: 0.2s;
            flex-shrink: 0; /* üÜï –í–ê–ñ–ù–û: –ß—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ —Å–ø–ª—é—â–∏–≤–∞–ª–∏—Å—å –≤ —Ä—è–¥ */
            display: flex; align-items: center;
            min-height: 36px;
        }
        .chip.active {
            background: var(--tg-theme-button-color, #3390ec); 
            color: white; 
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(51, 144, 236, 0.4);
        }
        
        /* –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞ */
        .load-chat-btn {
            position: sticky; bottom: 20px; left: 0; right: 0;
            background: #2ea043; color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            margin: 10px auto; width: 90%;
            animation: popIn 0.3s ease;
        }
        @keyframes popIn { from{transform: scale(0.9); opacity:0;} to{transform: scale(1); opacity:1;} }
        }
        .chip:hover { opacity: 0.8; }
    </style>
</head>
<body> 

    <div id="input-mode">
        <label>üìù –¢–µ–∫—Å—Ç:</label>
        <textarea id="main-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å..."></textarea>
        <div>
            <label>üßÆ –§–æ—Ä–º—É–ª–∞:</label>
            <math-field id="math-input" virtual-keyboard-mode="onfocus"></math-field>
            <button class="btn-insert" onclick="insertFormula()">‚¨ÜÔ∏è –í—Å—Ç–∞–≤–∏—Ç—å</button>
        </div>
        <button class="btn-send" onclick="sendData()">‚úàÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <div id="answer-mode" class="hidden">
        <h3>üéì –†–µ—à–µ–Ω–∏–µ:</h3>
        <div id="answer-content" class="answer-box"></div>
        <button style="background: #ccc; color: #333;" onclick="window.Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="admin-mode">
        <h3>üëë Dashboard</h3>
        <div id="loading-admin">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        
        <div id="users-container" class="user-list hidden"></div>
        
        <div id="sessions-container" class="session-bar hidden"></div>

        <div id="chat-container" class="chat-viewer hidden">
            <div style="text-align: center; opacity: 0.5; margin-top: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand(); marked.use({ breaks: true, gfm: true });

        function renderContent(text, elId='answer-content') {
            const da = document.getElementById(elId); const mb = [];
            let pt = text.replace(/\$\$([\s\S]*?)\$\$/g, m=>{mb.push(m);return '%%%B'+(mb.length-1)+'%%%'});
            pt = pt.replace(/\$([\s\S]*?)\$/g, m=>{mb.push(m);return '%%%I'+(mb.length-1)+'%%%'});
            let html = marked.parse(pt);
            html = html.replace(/%%%B(\d+)%%%/g, (m,i)=>mb[i]).replace(/%%%I(\d+)%%%/g, (m,i)=>mb[i]);
            da.innerHTML = html;
            renderMathInElement(da, {delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false}], throwOnError:false});
        }

        function insertFormula() { const mf = document.getElementById('math-input'), ta = document.getElementById('main-text'); if(!mf.value) return; const tag=" $"+mf.value+"$ ", s=ta.selectionStart; ta.value=ta.value.slice(0,s)+tag+ta.value.slice(ta.selectionEnd); ta.focus(); ta.selectionStart=s+tag.length; mf.setValue(""); }
        function sendData() { const t=document.getElementById('main-text').value; if(!t.trim()) return tg.showPopup({message:'–ü—É—Å—Ç–æ!'}); tg.sendData(JSON.stringify({full_text:t})); }

        const params = new URLSearchParams(window.location.search);
        const adminId = params.get('adminBinId'), dataId = params.get('binId'), direct = params.get('data');

        if(adminId) {
            document.getElementById('input-mode').classList.add('hidden');
            document.getElementById('admin-mode').style.display = 'flex';
            
            // –£–±—Ä–∞–ª –∑–∞–≥–æ–ª–æ–≤–∫–∏, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ CORS –æ—à–∏–±–∫–∏
            fetch(`https://api.jsonbin.io/v3/b/${adminId}/latest`)
            .then(r=>r.json())
            .then(json => {
                const db = json.record || json; 
                document.getElementById('loading-admin').classList.add('hidden');
                document.getElementById('users-container').classList.remove('hidden');
                document.getElementById('chat-container').classList.remove('hidden');
                renderUserList(db);
            })
            .catch(e => document.getElementById('loading-admin').innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: "+e);

        } else if(dataId || direct) {
            document.getElementById('input-mode').classList.add('hidden');
            document.getElementById('answer-mode').classList.remove('hidden');
            if(direct) renderContent(decodeURIComponent(direct));
            else fetch(`https://api.jsonbin.io/v3/b/${dataId}/latest`).then(r=>r.json()).then(j=>{
                const r = j.record || j; const a = r.answer || r; const q = r.query ? `<div class="query-quote"><b>–ó–∞–ø—Ä–æ—Å:</b> ${r.query}</div>` : "";
                renderContent(q + a);
            });
        }

        let currentUserData = null; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —é–∑–µ—Ä–∞

        function renderUserList(db) {
            const c = document.getElementById('users-container');
            c.innerHTML = "";
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è JSONBin
            const userIds = Object.keys(db).filter(k => k !== 'metadata' && k !== 'record' && typeof db[k] === 'object');
            
            if(userIds.length === 0) return c.innerHTML = "<div style='padding:10px'>–ü—É—Å—Ç–æ</div>";

            userIds.forEach(uid => {
                const u = db[uid]; 
                const card = document.createElement('div'); 
                card.className = 'user-card';
                
                // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const name = u.name || 'User ' + uid;
                // –ü–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
                const savedCount = u.saved_chats ? Object.keys(u.saved_chats).length : 0;
                
                card.innerHTML = `
                    <span class="user-name">${name}</span>
                    <span class="user-id">ID: ${uid}</span>
                    ${savedCount > 0 ? `<span style="font-size:10px; color:green">üìö ${savedCount} —à—Ç.</span>` : ''}
                `;
                
                card.onclick = () => { 
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    document.querySelectorAll('.user-card').forEach(x=>x.classList.remove('active')); 
                    card.classList.add('active'); 
                    
                    // üÜï –ó–∞–ø—É—Å–∫ —Ä–µ–Ω–¥–µ—Ä–∞ —Å–µ—Å—Å–∏–π
                    currentUserData = u;
                    renderSessions(u);
                };
                c.appendChild(card);
            });
        }

        // üÜï –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —Å–µ—Å—Å–∏–π
        function renderSessions(u) {
            const sc = document.getElementById('sessions-container');
            sc.innerHTML = "";
            sc.classList.remove('hidden');
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫-—á–∏–ø–æ–≤
            const createChip = (text, isCurrent, onClick) => {
                const chip = document.createElement('div');
                chip.className = 'chip' + (isCurrent ? ' active' : '');
                chip.innerText = text;
                chip.onclick = function() {
                    // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö
                    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    onClick();
                };
                sc.appendChild(chip);
            };

            // 1. –ß–∏–ø —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
            createChip("‚ö°Ô∏è –¢–µ–∫—É—â–∏–π", true, () => {
                removeLoadButton(); // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ (—Ç–µ–∫—É—â–∏–π –∏ —Ç–∞–∫ –∑–∞–≥—Ä—É–∂–µ–Ω)
                renderChat(u.history || []);
            });

            // 2. –ß–∏–ø—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤
            if (u.saved_chats) {
                Object.keys(u.saved_chats).forEach(chatName => {
                    createChip("üìÑ " + chatName, false, () => {
                        // –†–µ–Ω–¥–µ—Ä–∏–º –∏—Å—Ç–æ—Ä–∏—é
                        renderChat(u.saved_chats[chatName]);
                        // üÜï –ü–û–ö–ê–ó–´–í–ê–ï–ú –ö–ù–û–ü–ö–£ –ò–ú–ü–û–†–¢–ê
                        showLoadButton(chatName);
                    });
                });
            }
            
            // –°—Ä–∞–∑—É —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–µ–∫—É—â–∏–π
            renderChat(u.history || []);
        }

        // üÜï –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å"
        // üÜï –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        function showLoadButton(chatName) {
            removeLoadButton(); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é, –µ—Å–ª–∏ –±—ã–ª–∞
            
            const btn = document.createElement('button');
            btn.className = 'load-chat-btn';
            btn.id = 'btn-load-session';
            btn.innerHTML = `üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç ¬´${chatName}¬ª`;
            
            // –í–ê–ñ–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
            btn.onclick = function() {
                // 1. –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è
                btn.innerHTML = "‚è≥ –ó–∞–≥—Ä—É–∂–∞—é...";
                btn.style.opacity = "0.7";
                
                try {
                    // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
                    const payload = JSON.stringify({
                        action: 'load_session',
                        name: chatName
                    });
                    
                    // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–æ—Ç–∞
                    tg.sendData(payload);
                    
                    // 4. –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ (Telegram –∏–Ω–æ–≥–¥–∞ —Ç—É–ø–∏—Ç –∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–∞–º)
                    setTimeout(function() {
                        tg.close();
                    }, 50);
                    
                } catch (e) {
                    tg.showAlert("–û—à–∏–±–∫–∞ JS: " + e.message);
                }
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–¥–º–∏–Ω–∫–∏
            document.getElementById('admin-mode').appendChild(btn);
        }

        function removeLoadButton() {
            const existing = document.getElementById('btn-load-session');
            if(existing) existing.remove();
        }

        function setActiveChip(el) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        function renderChat(h) {
            const d = document.getElementById('chat-container'); d.innerHTML = "";
            if(!h || h.length===0) return d.innerHTML="<div style='text-align:center;margin-top:20px'>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>";
            h.forEach(m => {
                const b = document.createElement('div'); b.className = `msg ${m.role}`;
                const uid = 'msg-'+Math.random().toString(36).substr(2,9);
                b.innerHTML = `<span class="msg-role">${m.role==='user'?'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å':'AI'}</span><div id="${uid}"></div>`;
                d.appendChild(b); renderContent(m.content, uid);
            });
            d.scrollTop = d.scrollHeight;
        }
    </script>
</body>
</html>



