<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dashboard</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫ -->
    <script src="https://unpkg.com/mathlive"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js"></script>

    <style>
        /* ======================== –û–ë–©–ò–ï –°–¢–ò–õ–ò ======================== */
        body { 
            font-family: sans-serif; 
            background: var(--tg-theme-bg-color, #fff); 
            color: var(--tg-theme-text-color, #000); 
            margin: 0; 
            padding: 0;
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        .main-container {
            padding: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* ======================== –°–¢–ò–õ–ò –§–û–†–ú–´ –í–í–û–î–ê ======================== */
        math-field { 
            width: 100%; 
            font-size: 20px;
            padding: 10px; 
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000); 
            border: 1px solid var(--tg-theme-hint-color, #ccc); 
            border-radius: 12px; 
            margin-bottom: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        textarea { 
            width: 100%; 
            height: 120px; 
            border-radius: 12px; 
            padding: 12px; 
            border: 1px solid var(--tg-theme-hint-color, #ccc); 
            background: var(--tg-theme-secondary-bg-color, #f5f5f5); 
            color: var(--tg-theme-text-color, #000); 
            resize: none; 
            outline: none; 
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        textarea:focus {
            border-color: var(--tg-theme-link-color, #3390ec);
        }

        button { 
            border: none; 
            padding: 14px 20px; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 10px; 
            min-height: 50px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0; 
            transition: background 0.2s, transform 0.1s;
        }
        button:active {
            transform: scale(0.99);
        }

        /* –ö–Ω–æ–ø–∫–∞ "–í—Å—Ç–∞–≤–∏—Ç—å" —Å—Ç–∞–ª–∞ –±–æ–ª–µ–µ –∞–∫—Ü–µ–Ω—Ç–Ω–æ–π */
        .btn-insert { 
            background: var(--tg-theme-hint-color, #ccc); 
            color: var(--tg-theme-text-color, #333); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-send { 
            background: var(--tg-theme-button-color, #3390ec); 
            color: var(--tg-theme-button-text-color, white); 
            box-shadow: 0 4px 8px rgba(51, 144, 236, 0.4);
        }

        /* ======================== –°–¢–ò–õ–ò –û–¢–í–ï–¢–ê ======================== */
        .answer-box { 
            background: var(--tg-theme-section-bg-color, #fff); 
            padding: 16px; 
            border-radius: 12px; 
            border: 1px solid var(--tg-theme-secondary-bg-color, #eee); 
            word-wrap: break-word; 
            min-height: 150px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .query-quote { 
            /* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è —Ü–∏—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–∞ */
            border-left: 5px solid var(--tg-theme-hint-color, #ccc); 
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 10px 10px 10px 15px;
            margin-bottom: 15px; 
            opacity: 0.9; 
            font-size: 0.9em; 
            border-radius: 0 8px 8px 0;
        }
        
        /* ======================== –ê–î–ú–ò–ù–ö–ê / –ß–ê–¢–´ (–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ) ======================== */
        #admin-mode { 
            display: none; 
            flex-direction: column; 
            height: 100vh;
            padding: 0;
            overflow: hidden;
        }
        
        /* –°–¢–ò–õ–ò –í–õ–ê–î–û–ö (TABS) */
        .tabs-nav {
            display: flex;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
            margin-bottom: 10px;
        }
        .tab-button {
            flex: 1;
            text-align: center;
            padding: 12px 10px;
            cursor: pointer;
            font-weight: 600;
            color: var(--tg-theme-hint-color, #999);
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-bottom-color 0.2s;
        }
        .tab-button.active {
            color: var(--tg-theme-link-color, #3390ec);
            border-bottom-color: var(--tg-theme-link-color, #3390ec);
        }
        .tab-content {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        .tab-content.active {
            display: flex;
        }

        /* –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –ó–ê–ö–†–ï–ü–õ–ï–ù–ù–´–• –≠–õ–ï–ú–ï–ù–¢–û–í (Header) */
        .admin-header {
            background: var(--tg-theme-bg-color, #fff);
            padding: 16px 16px 0 16px;
            position: sticky;
            top: 0;
            z-index: 10;
            /* –£–±—Ä–∞–ª border-bottom, —Ç–∞–∫ –∫–∞–∫ –µ–≥–æ –∑–∞–º–µ–Ω—è–µ—Ç tabs-nav */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .user-list { 
            display: flex; 
            gap: 10px; 
            overflow-x: auto; 
            padding: 0 16px 10px 16px; 
            margin: 0 -16px; 
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0); /* –î–æ–±–∞–≤–∏–ª —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É —é–∑–µ—Ä–∞–º–∏ –∏ —Å–µ—Å—Å–∏—è–º–∏ */
        }

        .user-card { 
            min-width: 120px; 
            background: var(--tg-theme-secondary-bg-color, #eee); 
            padding: 10px; 
            border-radius: 10px; 
            cursor: pointer; 
            text-align: center; 
            border: 2px solid transparent; 
            transition: 0.2s;
            flex-shrink: 0;
        }
        .user-card.active { 
            border-color: var(--tg-theme-button-color, #3390ec); 
            background: var(--tg-theme-section-bg-color, #fff); 
        }

        .chat-viewer { 
            flex-grow: 1; 
            overflow-y: auto;
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            padding: 16px; 
            background: var(--tg-theme-bg-color, #fff); 
        }

        /* –°—Ç–∏–ª—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        .msg { 
            padding: 12px; 
            border-radius: 15px; 
            max-width: 85%; 
            font-size: 15px; 
            line-height: 1.4;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .msg.user { 
            align-self: flex-end; 
            background: var(--tg-theme-button-color, #3390ec); 
            color: var(--tg-theme-button-text-color, white); 
            border-bottom-right-radius: 4px;
        }
        .msg.assistant { 
            align-self: flex-start; 
            background: var(--tg-theme-secondary-bg-color, #e0e0e0); 
            color: var(--tg-theme-text-color, #000); 
            border-bottom-left-radius: 4px;
        }

        .session-bar {
            display: flex; gap: 8px; overflow-x: auto; 
            padding: 10px 16px;
            margin: 0 -16px;
            background: var(--tg-theme-bg-color, #fff);
            white-space: nowrap; 
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none;
        }
        .chip {
            padding: 8px 14px;
            border-radius: 18px; 
            font-size: 13px;
            cursor: pointer;
            background: var(--tg-theme-secondary-bg-color, #fff); 
            border: 1px solid var(--tg-theme-hint-color, #ccc); 
            color: var(--tg-theme-text-color, #000); 
            transition: 0.2s;
            flex-shrink: 0;
            display: flex; align-items: center;
        }
        .chip.active {
            background: var(--tg-theme-link-color, #3390ec);
            color: white; 
            border-color: transparent;
            box-shadow: 0 1px 4px rgba(51, 144, 236, 0.4);
        }
        
        /* –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞ */
        .load-chat-btn {
            position: sticky; bottom: 0; left: 0; right: 0;
            background: var(--tg-theme-link-color, #2ea043);
            color: white;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            margin: 0; 
            border-radius: 0;
            padding: 18px;
            z-index: 10;
        }
        
        .stats-card {
            background: var(--tg-theme-section-bg-color, #fff);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stats-card h4 {
            margin-top: 0;
            color: var(--tg-theme-link-color, #3390ec);
        }
        
    </style>
</head>
<body> 

    <!-- ======================== –†–ï–ñ–ò–ú –í–í–û–î–ê ======================== -->
    <div id="input-mode" class="main-container">
        <label style="font-weight: 500; margin-bottom: 5px; color: var(--tg-theme-hint-color);">üìù –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞:</label>
        <textarea id="main-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–¥–∞—á—É..."></textarea>
        <div style="margin-top: 15px;">
            <label style="font-weight: 500; margin-bottom: 5px; color: var(--tg-theme-hint-color);">üßÆ LaTeX –§–æ—Ä–º—É–ª–∞:</label>
            <math-field id="math-input" virtual-keyboard-mode="onfocus" style="margin-bottom: 5px;"></math-field>
            <button class="btn-insert" onclick="insertFormula()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><polyline points="18 15 12 9 6 15"></polyline></svg>
                –í—Å—Ç–∞–≤–∏—Ç—å –§–æ—Ä–º—É–ª—É –≤ –¢–µ–∫—Å—Ç
            </button>
        </div>
        <button class="btn-send" onclick="sendData()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13"></path></svg>
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ó–∞–ø—Ä–æ—Å AI
        </button>
    </div>

    <!-- ======================== –†–ï–ñ–ò–ú –û–¢–í–ï–¢–ê ======================== -->
    <div id="answer-mode" class="main-container hidden">
        <h3 style="margin-top: 0; color: var(--tg-theme-text-color);">üéì –†–µ—à–µ–Ω–∏–µ:</h3>
        <div id="answer-content" class="answer-box">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button style="background: var(--tg-theme-secondary-bg-color, #ccc); color: var(--tg-theme-text-color, #333); margin-top: 20px;" onclick="window.Telegram.WebApp.close()">
            –ó–∞–∫—Ä—ã—Ç—å Web App
        </button>
    </div>

    <!-- ======================== –†–ï–ñ–ò–ú –ê–î–ú–ò–ù–ö–ò/–ß–ê–¢–û–í (–° –¢–ê–ë–ê–ú–ò) ======================== -->
    <div id="admin-mode">
        
        <!-- –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π Header —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ -->
        <div class="admin-header">
            <h3 style="margin-top: 0; margin-bottom: 10px;">üëë –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h3>
            
            <div class="tabs-nav">
                <div class="tab-button active" onclick="switchAdminTab('chats')">
                    <span style="margin-right: 5px;">üë•</span> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ & –ß–∞—Ç—ã
                </div>
                <div class="tab-button" onclick="switchAdminTab('stats')">
                    <span style="margin-right: 5px;">üìà</span> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </div>
            </div>
        </div>

        <!-- –ö–û–ù–¢–ï–ù–¢ –í–ö–õ–ê–î–ö–ò "–ß–ê–¢–´" -->
        <div id="tab-chats" class="tab-content active" style="flex-grow: 1; overflow: hidden; position: relative;">
            <div id="loading-admin" style="text-align: center; padding: 20px; display: block;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            
            <!-- –°–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—á–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞) -->
            <div id="users-container" class="user-list hidden"></div>
            
            <!-- –°–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º–∞—è –ø–∞–Ω–µ–ª—å —Å–µ—Å—Å–∏–π (—á–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞) -->
            <div id="sessions-container" class="session-bar hidden"></div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–∞–º–∏–º —á–∞—Ç–æ–º (–ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º) -->
            <div id="chat-container" class="chat-viewer">
                <div style="text-align: center; opacity: 0.5; margin-top: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —á–∞—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
            </div>
            
            <!-- –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–ë—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∫—Ä–∏–ø—Ç–æ–º) -->
        </div>
        
        <!-- –ö–û–ù–¢–ï–ù–¢ –í–ö–õ–ê–î–ö–ò "–°–¢–ê–¢–ò–°–¢–ò–ö–ê" -->
        <div id="tab-stats" class="tab-content main-container">
            <div class="stats-card">
                <h4>–°–≤–æ–¥–∫–∞</h4>
                <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ:</strong> <span id="stat-users">...</span></p>
                <p><strong>–°–æ–æ–±—â–µ–Ω–∏–π (—Å–µ–≥–æ–¥–Ω—è/–≤—Å–µ–≥–æ):</strong> <span id="stat-messages">...</span></p>
                <p><strong>–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å:</strong> <span id="stat-model">...</span></p>
            </div>
            <div class="stats-card">
                <h4>–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</h4>
                <p><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ë–î:</strong> <span id="stat-last-save">...</span></p>
                <p><strong>–û—à–∏–±–æ–∫ AI:</strong> <span id="stat-errors">...</span></p>
            </div>
            <p style="opacity: 0.6; font-size: 0.9em;">(–î–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Python)</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; 
        tg.expand(); 
        marked.use({ breaks: true, gfm: true });

        // üÜï –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –í–ö–õ–ê–î–û–ö
        function switchAdminTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            buttons.forEach(btn => btn.classList.remove('active'));

            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–æ–π, –∏ –¥–µ–ª–∞–µ–º –µ—ë –∞–∫—Ç–∏–≤–Ω–æ–π
            const activeButton = Array.from(buttons).find(btn => 
                btn.getAttribute('onclick').includes(`'${tabId}'`)
            );
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }
        
        // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è Base64 (–¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ Clipboard API)
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å —É—á–µ—Ç–æ–º Markdown –∏ KaTeX
        function renderContent(text, elId='answer-content') {
            const da = document.getElementById(elId); 
            const mb = [];
            
            // –ó–∞–º–µ–Ω—è–µ–º –±–ª–æ–∫–∏ —Ñ–æ—Ä–º—É–ª ($$...$$) –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
            let pt = text.replace(/\$\$([\s\S]*?)\$\$/g, m => {
                mb.push(m);
                return '%%%B' + (mb.length - 1) + '%%%';
            });
            // –ó–∞–º–µ–Ω—è–µ–º –∏–Ω–ª–∞–π–Ω-—Ñ–æ—Ä–º—É–ª—ã ($...$) –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
            pt = pt.replace(/\$([\s\S]*?)\$/g, m => {
                mb.push(m);
                return '%%%I' + (mb.length - 1) + '%%%';
            });
            
            let html = marked.parse(pt);
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ—Ä–º—É–ª—ã –Ω–∞ –º–µ—Å—Ç–æ
            html = html.replace(/%%%B(\d+)%%%/g, (m, i) => mb[i]).replace(/%%%I(\d+)%%%/g, (m, i) => mb[i]);
            
            da.innerHTML = html;
            
            // –†–µ–Ω–¥–µ—Ä–∏–º KaTeX
            renderMathInElement(da, {
                delimiters: [{ left: '$$', right: '$$', display: true }, { left: '$', right: '$', display: false }], 
                throwOnError: false
            });
        }

        // –í—Å—Ç–∞–≤–∫–∞ —Ñ–æ—Ä–º—É–ª—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
        function insertFormula() { 
            const mf = document.getElementById('math-input'); 
            const ta = document.getElementById('main-text'); 
            
            if(!mf.value.trim()) return; 
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª –¥–æ –∏ –ø–æ—Å–ª–µ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
            const tag=" $"+mf.value.trim()+"$ ", s=ta.selectionStart; 
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É–ª—É –≤ –º–µ—Å—Ç–æ –∫—É—Ä—Å–æ—Ä–∞
            ta.value = ta.value.slice(0, s) + tag + ta.value.slice(ta.selectionEnd); 
            
            ta.focus(); 
            ta.selectionStart = s + tag.length; 
            
            mf.setValue(""); // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Ñ–æ—Ä–º—É–ª—ã
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É
        function sendData() { 
            const t = document.getElementById('main-text').value; 
            if(!t.trim()) return tg.showPopup({message:'–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞.'}); 
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç JSON, –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç Python-–±–æ—Ç
            tg.sendData(JSON.stringify({full_text: t})); 
        }

        const params = new URLSearchParams(window.location.search);
        const adminId = params.get('adminBinId');
        const dataId = params.get('binId');
        const direct = params.get('data');

        if(adminId) {
            // –ê–î–ú–ò–ù-–†–ï–ñ–ò–ú: –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∞–¥–º–∏–Ω–∫—É
            document.getElementById('input-mode').classList.add('hidden');
            document.getElementById('admin-mode').style.display = 'flex';
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            fetch(`https://api.jsonbin.io/v3/b/${adminId}/latest`)
            .then(r => {
                if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                return r.json();
            })
            .then(json => {
                const db = json.record || json; 
                document.getElementById('loading-admin').classList.add('hidden');
                document.getElementById('users-container').classList.remove('hidden');
                document.getElementById('sessions-container').classList.remove('hidden');
                document.getElementById('chat-container').classList.remove('hidden');
                renderUserList(db);
                
                // üÜï –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–ª—É—à–µ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                const userCount = Object.keys(db).filter(k => k !== 'metadata' && k !== 'record' && typeof db[k] === 'object').length;
                document.getElementById('stat-users').innerText = userCount;
                document.getElementById('stat-model').innerText = "Mistral Large (Mock)";
                document.getElementById('stat-messages').innerText = "150 / 8900 (Mock)";
                document.getElementById('stat-last-save').innerText = "2025-11-23 15:30:00 (Mock)";
                document.getElementById('stat-errors').innerText = "5 (Mock)";


            })
            .catch(e => {
                document.getElementById('loading-admin').innerHTML = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: " + e.message;
                console.error("Admin Load Error:", e);
            });

        } else if(dataId || direct) {
            // –†–ï–ñ–ò–ú –û–¢–í–ï–¢–ê: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ
            document.getElementById('input-mode').classList.add('hidden');
            document.getElementById('answer-mode').classList.remove('hidden');
            
            if(direct) {
                // –ü—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç (–≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É)
                renderContent(decodeURIComponent(direct));
            } else {
                // –û—Ç–≤–µ—Ç –∏–∑ –æ–±–ª–∞–∫–∞ (–¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç)
                fetch(`https://api.jsonbin.io/v3/b/${dataId}/latest`)
                .then(r => r.json())
                .then(j => {
                    const r = j.record || j; 
                    const a = r.answer || r; 
                    // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ —Ü–∏—Ç–∞—Ç—ã
                    const q = r.query ? `<div class="query-quote"><b>–ó–∞–ø—Ä–æ—Å:</b> ${r.query}</div>` : "";
                    renderContent(q + a);
                });
            }
        }

        let currentUserData = null; 

        function renderUserList(db) {
            const c = document.getElementById('users-container');
            c.innerHTML = "";
            const userIds = Object.keys(db).filter(k => k !== 'metadata' && k !== 'record' && typeof db[k] === 'object');
            
            if(userIds.length === 0) return c.innerHTML = "<div style='padding:10px'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</div>";

            userIds.forEach(uid => {
                const u = db[uid]; 
                const card = document.createElement('div'); 
                card.className = 'user-card';
                
                const name = u.name || `User ${uid}`;
                const savedCount = u.saved_chats ? Object.keys(u.saved_chats).length : 0;
                
                card.innerHTML = `
                    <span class="user-name" title="${name}">${name}</span>
                    <span class="user-id">ID: ${uid}</span>
                    ${savedCount > 0 ? `<span style="font-size:10px; color:#2ecc71; margin-top: 3px;">üìö ${savedCount} —à—Ç.</span>` : ''}
                `;
                
                card.onclick = () => { 
                    document.querySelectorAll('.user-card').forEach(x=>x.classList.remove('active')); 
                    card.classList.add('active'); 
                    
                    currentUserData = u;
                    renderSessions(u);
                };
                c.appendChild(card);
            });
            // –í—ã–¥–µ–ª—è–µ–º –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (c.firstChild) c.firstChild.click();
        }

        function renderSessions(u) {
            const sc = document.getElementById('sessions-container');
            sc.innerHTML = "";
            
            const createChip = (text, isCurrent, onClick) => {
                const chip = document.createElement('div');
                chip.className = 'chip' + (isCurrent ? ' active' : '');
                chip.innerText = text;
                chip.onclick = function() {
                    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    onClick();
                };
                sc.appendChild(chip);
            };

            // 1. –ß–∏–ø —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
            createChip("‚ö°Ô∏è –¢–µ–∫—É—â–∏–π", true, () => {
                removeLoadButton(); 
                renderChat(u.history || []);
            });

            // 2. –ß–∏–ø—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤
            if (u.saved_chats) {
                Object.keys(u.saved_chats).forEach(chatName => {
                    createChip("üìÑ " + chatName, false, () => {
                        renderChat(u.saved_chats[chatName]);
                        showLoadButton(chatName);
                    });
                });
            }
            
            // –°—Ä–∞–∑—É —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–µ–∫—É—â–∏–π, —É–±–µ–¥–∏–≤—à–∏—Å—å, —á—Ç–æ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
            if (sc.firstChild) sc.firstChild.click();
            else renderChat(u.history || []); // –†–µ–Ω–¥–µ—Ä –ø—É—Å—Ç–æ–≥–æ, –µ—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏
        }

        // üÜï –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Clipboard API
        function showLoadButton(chatName) {
            removeLoadButton();
            
            const btn = document.createElement('button');
            btn.className = 'load-chat-btn';
            btn.id = 'btn-load-session';
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ ¬´${chatName}¬ª`;
            
            btn.onclick = async function() {
                const command = JSON.stringify({
                    action: 'load_session',
                    name: chatName
                });
                
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π Clipboard API (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π)
                    if (navigator.clipboard) {
                        await navigator.clipboard.writeText(command);
                    } else {
                        // Fallback –¥–ª—è iFrame, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å Clipboard API
                        const tempInput = document.createElement('textarea');
                        tempInput.value = command;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                    }

                    tg.showPopup({
                        message: `‚úÖ –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞ ¬´${chatName}¬ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!\n\n–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –í—Å—Ç–∞–≤—å—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —Å—Ç—Ä–æ–∫—É –≤–≤–æ–¥–∞ Telegram –∏ –Ω–∞–∂–º–∏—Ç–µ –û—Ç–ø—Ä–∞–≤–∏—Ç—å.`,
                        buttons: [{id: 'close', type: 'default', text: '–ó–∞–∫—Ä—ã—Ç—å –∏ –≤—Å—Ç–∞–≤–∏—Ç—å'}]
                    }, () => {
                        tg.close();
                    });
                    
                } catch (e) {
                    tg.showAlert("‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑. (" + e.message + ")");
                }
            };
            
            document.getElementById('admin-mode').appendChild(btn);
        }

        function removeLoadButton() {
            const existing = document.getElementById('btn-load-session');
            if(existing) existing.remove();
        }

        function setActiveChip(el) {
            // –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ renderSessions
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        function renderChat(h) {
            const d = document.getElementById('chat-container'); d.innerHTML = "";
            if(!h || h.length === 0) return d.innerHTML="<div style='text-align:center; opacity: 0.6; margin-top: 20px;'>–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø—É—Å—Ç–∞.</div>";
            
            h.forEach(m => {
                const b = document.createElement('div'); 
                b.className = `msg ${m.role}`;
                const uid = 'msg-'+Math.random().toString(36).substr(2,9);
                
                // –î–æ–±–∞–≤–∏–ª —Ä–æ–ª—å –≤ —Å–∞–º–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
                const roleText = m.role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:' : 'AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç:';
                
                b.innerHTML = `<span class="msg-role" style="font-size: 0.8em; opacity: 0.7; display: block; margin-bottom: 5px;">${roleText}</span><div id="${uid}"></div>`;
                d.appendChild(b); 
                
                // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Å–æ–∑–¥–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
                renderContent(m.content, uid);
            });
            d.scrollTop = d.scrollHeight;
        }
    </script>
</body>
</html>
